<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Time-Travel Narratives • Delhi (Retelling)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;margin:0;background:#0f172a;color:#e5e7eb}
  header,footer{padding:12px 16px;background:#111827;position:sticky;top:0;z-index:10}
  main{padding:16px;max-width:900px;margin:0 auto}
  .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .panel{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{padding:6px 10px;border:1px solid #334155;border-radius:999px}
  button{border-radius:10px;border:1px solid #334155;background:#1f2937;color:#f1f5f9;padding:10px 14px;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  input,textarea{width:100%;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb;padding:10px}
  textarea{min-height:96px}
  .muted{color:#94a3b8;font-size:.9rem}
  .progress{height:8px;background:#1f2937;border-radius:999px;overflow:hidden}
  .progress>div{height:100%;background:#22c55e;width:0%}
  #chunkBody p{line-height:1.7;margin:0 0 .9rem}
</style>
</head>
<body>
<header class="row">
  <div><strong>Time-Travel Narratives • Delhi (Retelling)</strong></div>
  <span class="pill">Per-student randomized questions</span>
</header>

<main>
  <div class="card">
    <div class="panel">
      <label class="muted" for="studentId">Student ID (locks your question set)</label>
      <input id="studentId" placeholder="e.g., rollno or email" style="max-width:280px"/>
      <button id="lockSeed">Lock</button>
      <span id="seedStatus" class="muted"></span>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="panel">
      <span class="pill">~250–350 words / chunk</span>
      <span class="pill">Sentence-aware splitting</span>
      <span class="pill">Saves locally • Export CSV/JSON</span>
    </div>

    <div class="progress" style="margin-top:12px"><div id="progressFill"></div></div>
    <p class="muted" id="progressText" style="margin:.4rem 0 0">0 / 0</p>

    <h2 id="chunkTitle" style="margin-top:10px">Loading…</h2>
    <p class="muted" id="meta"></p>
    <div id="chunkBody"></div>

    <hr style="border:0;border-top:1px solid #1f2937;margin:16px 0"/>

    <div id="questionContainer"></div>

    <div class="row" style="margin-top:12px;justify-content:space-between">
      <button id="prevBtn">← Previous</button>
      <div class="row">
        <button id="saveBtn">Save</button>
        <button id="nextBtn">Next →</button>
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:14px">
    <button id="exportCSV">Export CSV</button>
    <button id="exportJSON">Export JSON</button>
    <button id="clearAll">Clear Saved Data</button>
    <button id="submitBtn">Submit to Teacher</button>
  </div>

  <p class="muted" style="margin-top:12px">
    Your answers stay on this device unless you export them.
  </p>
</main>

<footer><span class="muted">© Classroom use</span></footer>

<script>
/* ===================== 1) RETELLING TEXT (≈2000 words) ===================== */
const STORY_TITLE = "Delhi — A Retelling";
const STORY_META  = "Retold for classroom use; original spirit & order preserved.";
const FULL_TEXT = `
Aseem has learned to walk the city as if it were a living map of time. On certain nights, when the heat clings and the jasmine tang mixes with dust and exhaust, Delhi ripples for him. Horizons blur; the present grows porous. He can be standing beneath a highway bridge or on a neon-lit boulevard and feel a sideways tug—as if some older, parallel city is brushing past the one everyone else agrees is real. He once thought these were ghosts. Now he suspects something stranger: that Delhi is a palimpsest of eras, each one un-erased, and his eyes—by misfortune or grace—can sometimes read multiple ink layers at once.

From the shadow under a bridge he moves out toward the arterial roads, drawn to places where histories stack: tree-lined avenues, circles of white colonnades, ruins around which traffic loops. Apparitions often rise in the corner of his vision: a milkman guiding a white cow; soldiers with spears; poets leaning together in murmurous debate; a figure high on an elephant; a slim child gripping a balloon. None of them stay. They pass through as if the air were a membrane and Aseem the one person left with the old sense of touch. He keeps a notebook—frayed covers, bulging with scribbles and blank pages—because patterns visit him the way monsoon rain does: briefly, with meaning that can only be recognized later.

One day in Connaught Place, amidst the whitening glare and the parked cars and the steady shuffle of shoppers, Aseem meets a gaze that returns his. It belongs to an elderly woman dressed in clothes alien to the present. She seems to walk across a surface that isn’t there, rising and sinking on the topography of a vanished time. There’s rain-smell, though it is summer, the scent cutting through the season like an intrusion from some other afternoon. She studies him not as an apparition but as a person. When she asks what age he belongs to, the words are familiar Hindi shaped by an old mouth. Her king, she says, is Prithviraj Chauhan. Aseem, startled, tells her the centuries that separate them. For a minute they share testimonies: she has glimpsed armies, pale foreigners with hair like sun-bleached rope, and a woman confined inside a carriage of glittering metal. He gives her names for these fragments; she grants him the confirmation that he is not merely hallucinating. Then her presence thins like smoke, and when he lunges toward her, he collides with a pillar. Laughter rings out from a boy with a shoeshine box; a man chewing betel leaf smirks. They call him mad. The insult stings, but the old woman’s question matters more than the ridicule. Aseem now knows it is possible to be seen from another time.

He searches the city for more seams. Delhi obliges. Sometimes the British ride through on horses, all pale faces and stitched uniforms. Aseem, feeling an anger that isn’t solely his own, shouts at them that their empire will fail and their certainty is not guaranteed. Now and then a rider glances toward him, startled, as though a hairline crack has appeared in a mirror. Aseem imagines, in fanciful hours, that he’s nudged trajectories, planted doubts, altered outcomes. But when he’s honest with himself, he knows his role is less heroic. He is a witness that history has chosen, not a puppeteer the city hired to edit its past.

Still, he can’t stop writing. The notebook is half full of collisions with other centuries and half blank with premonitions he cannot yet translate. He thinks of the book as a second city, a portable Delhi in paper form: old quarters, new neighborhoods, and stretches of open ground yet to be developed. The blankness feels both accusing and merciful.

His wanderings lead him from boulevards to markets, from the old stone bones around Qutb to cramped lanes where scooters thread like insects through density. He senses lives that are not on maps: a mason quarrelling cheerfully with a friend while hauling blocks; a girl filling a pot at a well that the current city has long since sealed; voices floating from courtyards that no longer exist. The feeling that Delhi is alive—not metaphorically, but in some layered way he does not understand—grows harder to shake. When he stands still, he hears it breathe in overlapping tempos: a military drum, a temple bell, an auto-rickshaw’s horn, a future train gliding in silence.

In Old Delhi’s markets, reality piles up deliciously: the haggling over books and textiles, the sharp clatter of metal ladles against pans, the heat that seems to incarnate itself as a character with an attitude problem. Underneath the everyday, Aseem catches flashes—poets strolling with their arguments, a future protest that has not yet jammed these lanes, a courier galloping on a mission whose urgency he’ll never discover. The ordinary and the impossible twine as snugly as jalebi spirals. He is giddy and a little afraid.

The visions intensify. Near Jama Masjid he experiences a kaleidoscope—rebellion and courtly ceremony, smog and monsoon, slogans and prayers—so quick that his hand can’t keep up. The notebook fills with shorthand, arrows, drawings that look like a child’s attempt to trap motion. He worries that if the city keeps opening like this he will dissolve into it, become one more figure some other, future wanderer glimpses for a moment and fails to follow.

At the Yamuna he feels something close to peace, and with it, the terror that peace might be a form of vanishing. The river holds everyone, it seems, all the crossings and drownings and ritual immersions, yet also denies possession. Delhi existed before Aseem and will continue after him. In the summary the river writes, every person occupies a single line. He is smaller than he wishes, but maybe that’s a relief.

On a narrow lane packed with ruins and scaffolding, Aseem holds two periods in his palms like stones: the crumbled wall that remembers a quieter century and the new apartments rising with the inevitability of tidewater. He thinks of a tower with floors made of time—no roof, no basement, only an endless staircase you can climb or descend without reaching a definitive ground. The image comforts him because it suggests that even when stories end they do not vanish; they simply occupy another floor.

But life doesn’t leave him to metaphors. In Nai Sarak’s crush of students and stationery shops, a bus noses in too aggressively. The crowd compresses and surges. A young woman is shoved off balance. The chain of tiny causes—sweat, impatience, an elbow—becomes catastrophe. Aseem moves without planning. Later he will not be able to tell whether he saved her or she saved him, only that he felt time lurch and then resettle. In her gaze for a second is a look that seems to remember something ahead of schedule. Or perhaps he imagines that. The city is full of false confirmations.

Time folds back on Aseem’s own story. Three years have passed since he lost someone, since the grief had the precision of a blade. He nearly stepped off a bridge once. He wandered for days afterward, medicated and hollow, until the city’s overlaps began. It’s tempting to assign a plot here, to believe Delhi answered him as a partner would. He doesn’t know if the city cares. But he has learned that being alive is a task; it requires tending, and sometimes you keep at it because another person might need your presence at an hour neither of you can predict.

A card arrives—how exactly it finds him is unimportant—with the promise of counsel. It points to a modest shop in a market that hasn’t won any prizes for elegance. Behind a table sits Om Prakash, whose sign claims a degree, whose conversation meanders, and whose humor keeps its own weather. The window has a small beehive in it; bees come and go with civic briskness, mastering a micro-Delhi of their own. Om Prakash doesn’t sell miracles. He offers a kind of rough clarity. People come to him not for certainties but for a story that can hold their fear.

When Aseem describes his visions, the old woman in Connaught Place, the bus moment, the desire to intervene in history and the futility that follows, Om Prakash listens as if the details have visited him before in other clients’ voices. He produces an inkblot picture that, to Aseem’s eyes, resolves into the outline of a woman. Om Prakash does not interpret it exactly; he asks Aseem to live in such a way that he can be present for another at the right time, without controlling the moment or claiming authorship of it. “Witness,” the advice implies, “and act when it is yours to act. But don’t make the city a stage for your ego.”

Aseem leaves with purpose that feels fragile and therefore real. He walks again; the contradictions of Delhi remain: malls and beggars, leafy avenues and cramped tenements, police raids that bruise and the stubborn insistence of laughter afterward. In anger he returns to the Ridge—a ragged green lung where the city breathes differently. There, among scrub and rock and sudden quiet, he meets a woman who speaks of neighborhoods he has never heard of: Naya Diwas and Neechi Dilli. Her names are like coordinates in a map no current survey recognizes. She speaks not as a dream but as a visitor, although from where Aseem cannot tell. He thinks of the inkblot and feels dread and hope thrash like fish. Before he can frame a question properly she thins and is gone, the forest returning without apology.

Panicked that he failed her in some way he cannot articulate, Aseem rushes back to Om Prakash. The beehive hums; the old man shrugs gently at fate. Control is an illusion, he says in so many words. When we grasp it hardest we become cruel. The city doesn’t need more cruelty. What the living can offer is attention, readiness, and the smallest of brave choices when the minute demands it.

Later, waiting for a bus, Aseem meets a young woman reading an image printed from a blot. She smiles at the figure; where he sees a crystalline pattern she sees a skyline, or the other way around. Her training—biochemistry, perhaps—biases her toward one reading; he finds architecture in it. Their brief conversation entertains multiple futures because interpretation is how futures breed. The young woman’s laughter edges the world with possibility. Despair loosens in Aseem like a knot coming undone under water.

As the story loops toward its start, Aseem finds himself again on a bridge. The hour is the same—and not. An older version of him appears at the rail: bruised, used up, still alive. The figure manages a single word of warning that is also a plea. Time doubles over itself: the man who almost died once now tells himself not to. Whether that older version is truly from the future or from one of Delhi’s non-adjacent floors hardly matters. The effect is the same. Aseem steps back and sits, shaken. He does not know whether the noise leaving his mouth is a laugh or a sob. He looks at the city and senses its vastness again: the many-districted weave of love and hunger, ceremony and coping, empires that marched in and left, assurances that curdled, friendships that held.

He rises and begins to walk. The city does not applaud; it does not punish either. It simply continues—which in Delhi means continuing in layers. He remembers the old woman’s question in the parking lot and how she steadied him simply by seeing him. He remembers the bus lurch and the way a stranger’s life crossed his path like a thrown rope. He remembers a bee circling, unbothered by philosophy, intent on work. He remembers the river writing its calm, fast sentence. He does not know if he is altered history’s servant or merely its clerk. The difference may be academic. The living must choose their tasks. His task, he suspects, is to be ready within range of the next human emergency, to bring the future the one small gift available in the present: attention that does not flinch.

In the weeks that follow, his notebook gathers new entries. Some are only two lines long—a glimpse, a guess, an address—but he keeps them because tiny things are doorways. At the back of the book he leaves blank leaves on purpose now. They feel less like failure and more like hospitality, seats kept open for guests not yet arrived. He still catches the British, sometimes, riding past with their imported confidence. He’s stopped shouting at them; it was always a little too cinematic to be useful. He hears instead the cadence of an old monsoon and the click of a ballpoint he borrowed and never returned. Empires are loud, but their endings are not always announced at full volume. Often they drain away in the quieter rituals of ordinary people refusing to have their days entirely defined for them.

When the apparitions crowd him, he remembers to breathe in fours and sevens, a trick someone taught him for anxiety years ago. It doesn’t quell the visions, but it sizes them; they become scenes that pass rather than verdicts that capture. He looks for patterns—but more lightly now, with less insistence. The habit of meaning-making can be a tyrant; he tries to keep it a neighbor instead. On lucky days, the city announces its floor plan: he can feel the corridor that connects the Ridge to the market, the alley that links a ruin to an office block, the temporal stairwell that takes a scholar from the court of a vanished patron straight into a modern seminar. On unlucky days, he trusts the stair will be there even if he cannot see it.

Aseem doesn’t consider himself cured. The impulse to narrate one’s life as an arc that solves itself is strong; he refuses it. The city refuses it, too. Delhi’s achievement is not coherence but the capacity to hold what will not cohere. That’s why he belongs here—“belongs,” not as a claim but as an assignment. A citizen of overlaps, he tries to do the useful thing when overlap puts a human being within reach.

Sometimes he imagines the woman from the forest walking in one of the districts she named, the air crisp, the signage peculiar, the language almost-but-not-quite his. He does not know whether that city is a better version or merely another floor. He hopes for kindness there, for fewer raids and more laughter, for a margin of safety that allows the nervous system to unclench. He suspects that if such a future exists, it will not be delivered whole; it will be assembled by small mercies and work done without applause.

One evening he returns to the bridge, not to reenact anything but to take stock. The highway hums. Someone nearby lights a bidi. For an instant Aseem thinks he recognizes the shadowed face as his own, aged and detoured, but then the moment rights itself; we project ourselves into strangers all the time. He says his name aloud as a test, and it doesn’t slip away. He moves into the light and down the lane, and the city—generous, indifferent, alive—slides all around him, time and time again.
`;

/* ===================== 2) QUESTION POOLS ===================== */
// Default pool (used alongside any chunk-specific prompts)
const DEFAULT_POOL = [
  "Summarize this section in 2–3 sentences.",
  "Which detail best anchors you in Delhi here, and why?",
  "Past, Future, or Lateral time? Defend your choice using evidence.",
  "Identify a motif (notebook, river, city-as-living) and explain its role in this section.",
  "What is Aseem learning here that he didn’t know before?",
  "Connect one idea from this section to your life.",
  "Quote-like phrase (paraphrase allowed): what effect does it create and how?",
  "Is the tone hopeful or fatalistic? Why?"
];

// Chunk-specific prompts keyed by 1-based chunk index (we’ll fill after splitting)
const CHUNK_QUESTIONS = {
  1: [
    "What does the opening reveal about Aseem’s perception of time and city?",
    "How does the ‘palimpsest’ idea frame everything that follows?"
  ],
  2: [
    "Why is the Connaught Place encounter different from earlier glimpses?",
    "What does public ridicule do to Aseem’s self-understanding?"
  ],
  3: [
    "Witness vs. editor of history: where does Aseem stand in this section?",
    "How do the notebook’s blank pages function as meaning or suspense?"
  ],
  4: [
    "List two ordinary market details that make the fantasy feel real.",
    "Where do layered times peek through the everyday bustle?"
  ],
  5: [
    "Why does Aseem fear ‘dissolving into the city’ here?",
    "How do notebook sketches reflect his struggle?"
  ],
  6: [
    "River symbolism: what truth about Delhi/Aseem does it suggest?",
    "Explain the ‘tower of time’ image using specific lines."
  ],
  7: [
    "Nai Sarak: how do tiny causes scale into catastrophe?",
    "Did he save her or did she save him? Argue both ways briefly."
  ],
  8: [
    "What does the ending say about belonging and action in a layered city?",
    "Where do you see attention (witnessing) as the core ethic of the story?"
  ]
};

/* ===================== 3) SPLITTING INTO CHUNKS ===================== */
const TARGET_MIN = 250, TARGET_MAX = 350; // words per chunk

function sanitize(s){ return s.replace(/[<>]/g, m=>({'<':'&lt;','>':'&gt;'}[m])); }
function normalize(text){
  return text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').replace(/[ \t]+\n/g,'\n').replace(/\u00A0/g,' ');
}
function sentenceSplit(p){
  return p.split(/(?<=[\.!?])\s+(?=[A-Z(“"'])/u);
}
function paragraphsFrom(text){
  const t = normalize(text);
  const blocks = t.split(/\n\s*\n/g).map(b=>b.trim()).filter(Boolean);
  if (blocks.length > 1) return blocks;
  // Fall back to sentence-based regrouping if no blank lines
  const sents = sentenceSplit(t);
  const res = []; let cur=[];
  for(const s of sents){ cur.push(s); if(cur.join(' ').split(/\s+/).length >= 70){ res.push(cur.join(' ')); cur=[]; } }
  if(cur.length) res.push(cur.join(' '));
  return res.length ? res : [t];
}
function wc(str){ return str.replace(/<[^>]*>/g,' ').trim().split(/\s+/).filter(Boolean).length; }

function buildChunks(text){
  const paras = paragraphsFrom(text);
  const out = [];
  let buf=[], words=0;
  const push = ()=>{
    if(!buf.length) return;
    const html = buf.map(p=>`<p>${sanitize(p)}</p>`).join('');
    out.push({title:`Chunk ${out.length+1}`, meta: STORY_META, body: html, questions:[], pickCount:3});
    buf=[]; words=0;
  };
  for(const p of paras){
    let w = wc(p);
    if(words >= TARGET_MIN && (words+w) > TARGET_MAX){ push(); }
    // huge paragraph → split by sentences
    if(w > TARGET_MAX){
      const sents = sentenceSplit(p);
      let sb=[], sw=0;
      for(const s of sents){
        const sW = wc(s);
        if(sw >= Math.floor((TARGET_MIN+TARGET_MAX)/2) && (sw+sW) > TARGET_MAX){
          buf.push(sb.join(' ')); words += sw; push();
          sb=[]; sw=0;
        }
        sb.push(s); sw += sW;
      }
      if(sb.length){ buf.push(sb.join(' ')); words += sw; }
    }else{
      buf.push(p); words += w;
    }
  }
  push();

  // Map chunk-specific questions by index (fallback to default pool)
  out.forEach((c,i)=>{
    const n = i+1;
    c.questions = Array.from(new Set([...(CHUNK_QUESTIONS[n]||[]), ...DEFAULT_POOL]));
  });
  return out;
}

const chunks = buildChunks(FULL_TEXT);

/* ===================== 4) PER-STUDENT SEEDED RANDOM ===================== */
// Hash & PRNG
function xmur3(str){ let h=1779033703^str.length; for(let i=0;i<str.length;i++){ h=Math.imul(h^str.charCodeAt(i),3432918353); h=h<<13|h>>>19;} return ()=>{ h=Math.imul(h^(h>>>16),2246822507); h=Math.imul(h^(h>>>13),3266489909); return (h^(h>>>16))>>>0; }; }
function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; }; }
function seededSample(arr, k, rng){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){ const j=Math.floor(rng()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  return a.slice(0, Math.max(0, Math.min(k, a.length)));
}

/* ===================== 5) APP STATE & UI ===================== */
let idx = 0;
const answersKey = "ttn-delhi-retell-answers";
const picksKey   = "ttn-delhi-retell-picks";
const studentKey = "ttn-delhi-retell-student";

const $ = s=>document.querySelector(s);
const studentIdInput=$("#studentId"), lockBtn=$("#lockSeed"), seedStatus=$("#seedStatus");
const progressFill=$("#progressFill"), progressText=$("#progressText");
const chunkTitle=$("#chunkTitle"), chunkBody=$("#chunkBody"), meta=$("#meta"), qBox=$("#questionContainer");
const prevBtn=$("#prevBtn"), nextBtn=$("#nextBtn"), saveBtn=$("#saveBtn");

function getSaved(){ try{return JSON.parse(localStorage.getItem(answersKey)||"{}")}catch{ return {}; } }
function setSaved(o){ localStorage.setItem(answersKey, JSON.stringify(o)); }
function getPicks(){ try{return JSON.parse(localStorage.getItem(picksKey)||"{}")}catch{ return {}; } }
function setPicks(o){ localStorage.setItem(picksKey, JSON.stringify(o)); }
function getStudentId(){ return localStorage.getItem(studentKey) || ""; }
function setStudentId(v){ localStorage.setItem(studentKey, v); }

function reseedPicksFor(studentId){
  const seedFn = xmur3(studentId || "default");
  const rng = mulberry32(seedFn());
  const all = {};
  chunks.forEach((c,i)=> all[i] = seededSample(c.questions, c.pickCount ?? 3, rng));
  setPicks(all);
}

function ensureSeed(){
  const sid = getStudentId();
  if(sid){
    studentIdInput.value = sid;
    seedStatus.textContent = `Locked for: ${sid}`;
    const p = getPicks();
    if(!p || Object.keys(p).length !== chunks.length){ reseedPicksFor(sid); }
  }else{
    seedStatus.textContent = "Enter Student ID and click Lock to fix your question set.";
  }
}

lockBtn.addEventListener("click", ()=>{
  const sid = (studentIdInput.value||"").trim();
  if(!sid){ seedStatus.textContent="Please enter a Student ID first."; return; }
  setStudentId(sid);
  reseedPicksFor(sid);
  seedStatus.textContent = `Locked for: ${sid}`;
  render();
});

function render(){
  const total = chunks.length || 1;
  progressFill.style.width = Math.round(((idx+1)/total)*100) + "%";
  progressText.textContent = `${idx+1} / ${total}`;

  const c = chunks[idx];
  chunkTitle.textContent = `Chunk ${idx+1}`;
  meta.textContent = STORY_META;
  chunkBody.innerHTML = c.body;

 let picksAll = getPicks() || {};
const sid = getStudentId();
if (!picksAll[idx]) {
  if (sid) {
    // seeded per-student
    reseedPicksFor(sid);
    picksAll = getPicks() || {};
  } else {
    // no seed yet → create & persist a fallback set so export can't be blank
    const fallback = seededSample(c.questions, c.pickCount ?? 3, mulberry32(123456 + idx));
    picksAll[idx] = fallback;
    setPicks(picksAll);
  }
}
const picks = picksAll[idx];
  }
  const picks = (picksAll && picksAll[idx]) ? picksAll[idx] : (()=>{
    const rng = mulberry32(123456); return seededSample(c.questions, c.pickCount ?? 3, rng);
  })();

  qBox.innerHTML = "";
  const saved = getSaved();
  const savedFor = saved[idx] || {};
  picks.forEach((q,qi)=>{
    const id = `q_${idx}_${qi}`;
    const wrap = document.createElement("div");
    wrap.className = "q";
    wrap.innerHTML = `<div>${qi+1}. ${q}</div><textarea id="${id}" rows="4" placeholder="Type your response…"></textarea>`;
    qBox.appendChild(wrap);
    const ta = document.getElementById(id);
    ta.value = savedFor[qi] || "";
    ta.addEventListener("input", ()=>{
      const s = getSaved(); s[idx] = s[idx] || {}; s[idx][qi] = ta.value; setSaved(s);
    });
  });

  prevBtn.disabled = idx===0;
  nextBtn.disabled = idx===total-1;
}

prevBtn.addEventListener("click", ()=>{ if(idx>0){ idx--; render(); }});
nextBtn.addEventListener("click", ()=>{ if(idx<chunks.length-1){ idx++; render(); }});
saveBtn.addEventListener("click", ()=>{ saveBtn.textContent="Saved ✓"; setTimeout(()=>saveBtn.textContent="Save",900); });

document.getElementById("exportJSON").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify({
    title: STORY_TITLE,
    studentId: getStudentId(),
    answers: getSaved(),
    picks: getPicks(),
    chunks: chunks.map((c,i)=>({index:i+1, words: wc(c.body)}))
  }, null, 2)], {type:"application/json"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "ttn-delhi-retelling-responses.json"; a.click();
});
document.getElementById("exportCSV").addEventListener("click", ()=>{
  const saved = getSaved(); 
let picks = getPicks() || {}; 
const sid = getStudentId() || "";
let rows = [["student_id","chunk","q_index","question","answer"]];

chunks.forEach((c,i)=>{
  // if this chunk somehow has no saved picks, generate a deterministic fallback
  if (!picks[i] || !picks[i].length) {
    const rng = mulberry32(999001 + i);
    picks[i] = seededSample(c.questions, c.pickCount ?? 3, rng);
  }
  picks[i].forEach((q,qi)=>{
    const ans = (saved[i] && saved[i][qi]) ? saved[i][qi].replace(/\n/g," ") : "";
    rows.push([sid, i+1, qi+1, q, ans]);
  });
});

// persist any regenerated picks so future exports match
setPicks(picks);
  const csv = rows.map(r=>r.map(v=>`"${(v||"").replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv"}); const a = document.createElement("a");
  a.href = URL.createObjectURL(blob); a.download = "ttn-delhi-retelling-responses.csv"; a.click();
});
document.getElementById("clearAll").addEventListener("click", ()=>{
  localStorage.removeItem(answersKey);
  localStorage.removeItem(picksKey);
  // keep student ID so their question set stays consistent
  render();
});

/* init */
ensureSeed();
render();
</script>
</body>
</html>
<script>
const SUBMIT_URL = "PASTE_YOUR_APPS_SCRIPT_URL_HERE"; // <-- from step 1

async function submitToSheet({course, activity, studentId, answers, picks, meta={}}){
  const payload = {
    course,
    activity,
    student_id: studentId,
    payload: { answers, picks, meta }
  };
  try {
    await fetch(SUBMIT_URL, {
      method: "POST",
      mode: "no-cors",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    alert("Submitted! (Keep your CSV/JSON export as backup.)");
  } catch (e) {
    alert("Could not submit right now. Please Export CSV as backup.");
  }
}

// wire the button
document.getElementById("submitBtn").addEventListener("click", ()=>{
  const sid = localStorage.getItem("ttn-delhi-retell-student") || prompt("Student ID?");
  const answers = JSON.parse(localStorage.getItem("ttn-delhi-retell-answers") || "{}");
  const picks   = JSON.parse(localStorage.getItem("ttn-delhi-retell-picks") || "{}");
  submitToSheet({
    course: "TTN",
    activity: "Delhi — Retelling",
    studentId: sid || "",
    answers,
    picks,
    meta: { userAgent: navigator.userAgent }
  });
});
</script>
